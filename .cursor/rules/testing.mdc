---
description: "Testing guidelines and practices"
globs: ["**/*"]
alwaysApply: true
---

## Testing
- **ALWAYS follow TDD Red-Green-Refactor cycle:**
  1. **RED**: Write failing test first (defines requirements)
     - Test should fail for the right reason (missing functionality, not syntax error)
     - Run tests to confirm they fail (RED)
  2. **GREEN**: Write minimal code to make test pass
     - Don't optimize or refactor yet - just make it work
     - Run tests to confirm they pass (GREEN)
  3. **REFACTOR**: Improve code while keeping tests green
     - Remove duplication, improve readability, apply design patterns
     - Extract methods/classes, simplify logic
     - Run tests after each refactoring step to ensure they still pass
     - Only refactor when tests are green
- Prefer classical/Detroit style testing (state verification, limited mocking); avoid London/mockist approach by default
- Add/adjust tests when behavior changes or bugs are fixed
- Run relevant suites (PHPUnit/PHPStan) when feasible; state when not run
- Follow test structure: Arrange-Act-Assert pattern
- Write descriptive test method names that explain what is being tested
- Ensure unit tests for individual components and integration tests for interactions
- Test edge cases and error conditions; all tests pass before committing
- **Never skip the REFACTOR step** - it's part of TDD, not optional